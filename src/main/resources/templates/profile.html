<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | Mossaq</title>
    <style>
        /* --- VARIABLES & RESET (Copied from Dashboard) --- */
        :root {
            --primary: #1db954;
            --primary-hover: #1ed760;
            --bg-dark: #121212;
            --bg-card: #181818;
            --bg-hover: #282828;
            --text-main: #ffffff;
            --text-muted: #b3b3b3;
            --border: #333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        a { text-decoration: none; color: inherit; }

        /* --- LAYOUT GRID --- */
        .app-container {
            display: grid;
            grid-template-columns: 240px 1fr; /* Sidebar | Content */
            height: 100vh;
        }

        /* --- LEFT SIDEBAR --- */
        .sidebar-left {
            background-color: black;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--text-main);
        }
        .logo span { color: var(--primary); }

        .nav-menu { list-style: none; }
        .nav-item { margin-bottom: 1rem; }
        
        .nav-link {
            display: flex;
            align-items: center;
            color: var(--text-muted);
            font-weight: 600;
            padding: 0.5rem 0;
            transition: 0.2s;
        }
        .nav-link:hover, .nav-link.active { color: var(--text-main); }
        .nav-icon { margin-right: 10px; width: 20px; text-align: center; }

        /* --- MAIN CONTENT --- */
        .main-content {
            overflow-y: auto;
            padding: 2rem;
            background: linear-gradient(to bottom, #1e1e1e, #121212);
        }

        /* --- PROFILE HEADER --- */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .profile-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: #555;
            box-shadow: 0 4px 60px rgba(0,0,0,0.5);
            object-fit: cover;
        }

        .profile-info h1 { font-size: 3rem; margin-bottom: 0.5rem; font-weight: 800; }
        .profile-info p { color: var(--text-muted); margin-bottom: 1.5rem; }

        .btn-edit {
            background: transparent;
            border: 1px solid var(--text-muted);
            color: var(--text-main);
            padding: 8px 24px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: 0.2s;
        }
        .btn-edit:hover { border-color: var(--text-main); transform: scale(1.05); }

        /* --- TRACK LIST (Simplified from Dashboard) --- */
        .section-title { margin-bottom: 1.5rem; font-size: 1.5rem; }

        .track-card {
            background-color: var(--bg-card);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: background 0.3s;
        }
        .track-card:hover { background-color: var(--bg-hover); }

        .track-art {
            width: 50px;
            height: 50px;
            background: #333;
            border-radius: 4px;
            object-fit: cover;
        }

        .track-details { flex: 1; }
        .track-details h4 { font-size: 1rem; margin-bottom: 4px; }
        .track-details span { font-size: 0.8rem; color: var(--text-muted); }

        .play-btn-small {
            background: var(--primary);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Audio Player Hidden Logic */
        audio { display: none; }

        .btn-logout {
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
        }
        .btn-logout:hover {
            color: #ff4b4b;
        }

        /* Search Styles */
        .search-bar { display: flex; gap: 10px; margin-bottom: 2rem; }
        .search-input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #333; background: #181818; color: white; }
        .search-btn { background: var(--primary); border: none; padding: 0 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .search-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .user-card { background: #181818; padding: 1rem; border-radius: 8px; text-align: center; }
        .user-card:hover { background: #282828; }

        /* Friend List Styles */
        .friend-request-card { background: #222; padding: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .btn-accept { background: var(--primary); color: black; border: none; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-weight: bold; margin-right: 5px; }
        .btn-decline { background: transparent; border: 1px solid #555; color: #aaa; padding: 5px 15px; border-radius: 15px; cursor: pointer; }
    </style>
</head>
<body>

<div class="app-container">
    
    <aside class="sidebar-left">
        <div class="logo">Mossaq<span>.</span></div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="/main" class="nav-link">
                    <span class="nav-icon">üè†</span> <span class="nav-text">Home</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">
                    <span class="nav-icon">üéµ</span> <span class="nav-text">My Library</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/profile" class="nav-link active">
                    <span class="nav-icon">üë§</span> <span class="nav-text">Profile</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/settings" class="nav-link">
                    <span class="nav-icon">‚öôÔ∏è</span> <span class="nav-text">Settings</span>
                </a>
            </li>
        </ul>

        <form th:action="@{/logout}" method="post" style="margin-top: auto;">
            <button type="submit" class="nav-link btn-logout">
                <span class="nav-icon">üö™</span> <span class="nav-text">Logout</span>
            </button>
        </form>
    </aside>

    <main class="main-content">
        
        <div class="profile-header">
            <img th:if="${avatar}" th:src="@{'/avatar/' + ${avatar}}" class="profile-avatar">
            <div th:unless="${avatar}" class="profile-avatar">üë§</div>
            <div class="profile-info">
                <p>Profile</p>
                <h1 th:text="${username}">Username</h1>
                <p th:text="${email}">user@example.com</p>
                <p th:if="${bio}" th:text="${bio}" style="color: var(--text-muted); font-style: italic; margin-bottom: 1rem;">User Bio</p>
                <a href="/settings" class="btn-edit">Edit Profile</a>
            </div>
        </div>

        <!-- User Search -->
        <form action="/profile/search" method="get" class="search-bar">
            <input type="text" name="query" class="search-input" placeholder="Search for other users..." th:value="${searchQuery}">
            <button type="submit" class="search-btn">Search</button>
        </form>

        <div th:if="${searchResults}" class="search-results">
            <div th:each="user : ${searchResults}" class="user-card">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üë§</div>
                <h3 th:text="${user.username}" style="font-size: 1.1rem; margin-bottom: 0.5rem;">Username</h3>
                <a th:href="@{'/user/' + ${user.uuid}}" class="btn-edit" style="font-size: 0.8rem; padding: 4px 12px;">View Profile</a>
            </div>
            <div th:if="${#lists.isEmpty(searchResults)}" style="grid-column: 1/-1; color: var(--text-muted);">
                No users found matching your search.
            </div>
        </div>

        <!-- Friend Requests -->
        <div th:if="${!#lists.isEmpty(incomingRequests)}">
            <h2 class="section-title">Friend Requests</h2>
            <div th:each="req : ${incomingRequests}" class="friend-request-card">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div style="font-size: 1.5rem;">üë§</div>
                    <span th:text="${req.user.username}" style="font-weight:bold;">User</span>
                </div>
                <div>
                    <form th:action="@{/friend/accept/{id}(id=${req.friendshipId})}" method="post" style="display:inline;">
                        <button type="submit" class="btn-accept">Accept</button>
                    </form>
                    <form th:action="@{/friend/decline/{id}(id=${req.friendshipId})}" method="post" style="display:inline;">
                        <button type="submit" class="btn-decline">Decline</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Friends List -->
        <div th:if="${!#lists.isEmpty(friends)}">
            <h2 class="section-title">My Friends</h2>
            <div class="search-results">
                <div th:each="friend : ${friends}" class="user-card">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üë§</div>
                    <h3 th:text="${friend.username}" style="font-size: 1.1rem; margin-bottom: 0.5rem;">Username</h3>
                    <a th:href="@{'/user/' + ${friend.uuid}}" class="btn-edit" style="font-size: 0.8rem; padding: 4px 12px;">View Profile</a>
                </div>
            </div>
        </div>

        <h2 class="section-title">Your Uploads</h2>

        <div th:if="${#lists.isEmpty(tracks)}" style="color: var(--text-muted);">
            <p>You haven't uploaded any tracks yet.</p>
        </div>

        <div class="track-list">
            <div class="track-card" th:each="track : ${tracks}">
                <img th:src="@{'/track/' + ${track.id} + '/art'}" class="track-art" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjMzMzIi8+PC9zdmc+'">
                
                <button class="play-btn-small" th:data-track-id="${track.id}" onclick="togglePlay(this, this.getAttribute('data-track-id'))">‚ñ∂</button>
                
                <div class="track-details" style="margin-left: 1rem;">
                    <h4 th:text="${track.title}">Title</h4>
                    <span th:text="${track.artist}">Artist</span>
                </div>

                <div style="color: var(--text-muted); font-size: 0.9rem; margin-right: 1rem;">
                    <span th:text="${track.playCount}">0</span> plays
                </div>
                <div style="color: var(--text-muted); font-size: 0.9rem;">
                    <span th:text="${track.likeCount}">0</span> likes
                </div>

                <!-- Delete Button Form -->
                <form th:action="@{/track/{id}/delete(id=${track.id})}" method="post"
                      style="display:inline;"
                      onsubmit="return confirm('Are you sure you want to delete this track? This cannot be undone.');"><button type="submit" style=" background-color:red; color:white" class="btn-delete">Delete</button>
                </form>
                <audio th:id="'audio-' + ${track.id}" th:src="@{'/track/' + ${track.id} + '/stream'}" onended="resetBtn(this)"></audio>
            </div>
        </div>

    </main>

</div>

<script>
    let currentAudio = null;
    let currentBtn = null;

    function togglePlay(btn, trackId) {
        const audio = document.getElementById('audio-' + trackId);

        if (currentAudio && currentAudio !== audio) {
            currentAudio.pause();
            if(currentBtn) currentBtn.innerText = '‚ñ∂';
        }

        if (audio.paused) {
            audio.play();
            btn.innerText = '‚è∏';
            currentAudio = audio;
            currentBtn = btn;
        } else {
            audio.pause();
            btn.innerText = '‚ñ∂';
            currentAudio = null;
            currentBtn = null;
        }
    }

    function resetBtn(audio) {
        // Find the button associated with this audio
        // Since we don't have a direct link in this simple script, we rely on the user clicking.
        // But for auto-reset on end:
        if(currentBtn) currentBtn.innerText = '‚ñ∂';
        currentAudio = null;
    }
</script>

</body>
</html>