<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream | Mossaq</title>
    <style>
        /* --- VARIABLES & RESET --- */
        :root {
            --primary: #1db954;
            --primary-hover: #1ed760;
            --bg-dark: #121212;
            --bg-card: #181818;
            --bg-hover: #282828;
            --text-main: #ffffff;
            --text-muted: #b3b3b3;
            --border: #333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden; /* Main scroll is handled inside columns */
        }

        a { text-decoration: none; color: inherit; }

        /* --- LAYOUT GRID --- */
        .app-container {
            display: grid;
            grid-template-columns: 240px 1fr 300px; /* Sidebar | Feed | Extras */
            height: 100vh;
        }

        /* --- LEFT SIDEBAR (Navigation) --- */
        .sidebar-left {
            background-color: black;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--text-main);
        }
        .logo span { color: var(--primary); }

        .nav-menu { list-style: none; }
        .nav-item { margin-bottom: 1rem; }
        
        .nav-link {
            display: flex;
            align-items: center;
            color: var(--text-muted);
            font-weight: 600;
            padding: 0.5rem 0;
            transition: 0.2s;
        }
        .nav-link:hover, .nav-link.active { color: var(--text-main); }
        .nav-icon { margin-right: 10px; width: 20px; text-align: center; }

        /* --- CENTER FEED (Music Stream) --- */
        .main-feed {
            overflow-y: auto;
            padding: 2rem;
            background: linear-gradient(to bottom, #1e1e1e, #121212);
        }

        .feed-header { margin-bottom: 2rem; }
        .feed-header h2 { font-size: 1.8rem; }

        /* --- MUSIC CARD COMPONENT --- */
        .track-card {
            background-color: var(--bg-card);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: background 0.3s;
            cursor: pointer;
        }
        .track-card:hover { background-color: var(--bg-hover); }

        .track-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .artist-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #333;
            margin-right: 1rem;
            object-fit: cover;
        }

        .track-info h3 { font-size: 1rem; font-weight: 700; }
        .track-info span { font-size: 0.8rem; color: var(--text-muted); }

        /* Visual Audio Player Stub */
        .audio-player-ui {
            background: #000;
            border-radius: 6px;
            padding: 1rem;
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .player-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .play-btn {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: transform 0.2s;
            flex-shrink: 0;
        }
        .play-btn:hover { transform: scale(1.1); }

        .waveform {
            width: 100%;
            height: 30px;
            display: flex;
            align-items: center;
            gap: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .bar { width: 4px; background: var(--text-muted); border-radius: 2px; }
        /* Fake waveform heights for visuals */
        .bar:nth-child(odd) { height: 15px; }
        .bar:nth-child(even) { height: 25px; }
        .bar:nth-child(3n) { height: 10px; }
        
        /* Seek Bar & Time */
        .seek-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .time-text {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
            min-width: 35px;
        }

        .seek-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 4px;
            background: #333;
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }
        .seek-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 10px;
            height: 10px;
            background: var(--text-main);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .seek-slider::-webkit-slider-thumb:hover { transform: scale(1.3); }

        .track-actions {
            display: flex;
            gap: 1.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
        }
        .action-btn:hover { color: var(--text-main); }
        .action-btn.like:hover { color: #e91e63; } /* Pink for like */

        /* --- RIGHT SIDEBAR (Upload & Suggestions) --- */
        .sidebar-right {
            background-color: black;
            padding: 1.5rem;
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* UPLOAD WIDGET */
        .upload-box {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border: 1px dashed var(--text-muted);
        }
        
        .upload-box h4 { margin-bottom: 0.5rem; }
        .upload-box p { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem; }
        
        .btn-upload {
            background: var(--primary);
            color: black;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
        }

        /* SUGGESTIONS LIST */
        .suggestions h4 { margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;}

        .artist-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .artist-profile { display: flex; align-items: center; gap: 10px; }
        .mini-avatar { width: 32px; height: 32px; border-radius: 50%; background: #444; }
        .artist-name { font-size: 0.9rem; font-weight: 600; }
        
        .btn-follow {
            background: transparent;
            border: 1px solid var(--text-muted);
            color: var(--text-main);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.7rem;
            cursor: pointer;
        }
        .btn-follow:hover { border-color: var(--text-main); }

        /* --- INPUTS FOR UPLOAD --- */
        .upload-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background: #121212;
            border: 1px solid #333;
            color: white;
            border-radius: 4px;
        }

        /* Dynamic Waveform Animation */
        .audio-player-ui.playing .bar {
            animation-name: sound-wave;
            animation-timing-function: ease-in-out;
            animation-iteration-count: infinite;
            animation-direction: alternate;
        }
        @keyframes sound-wave {
            0% { height: 4px; opacity: 0.6; }
            100% { height: 28px; opacity: 1; }
        }

        /* --- COMMENT SECTION --- */
        .comment-box {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            display: none; /* Hidden by default */
        }
        .comment-form {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }
        .comment-input {
            flex: 1;
            background: #121212;
            border: 1px solid #333;
            color: white;
            padding: 8px;
            border-radius: 4px;
        }
        .btn-comment {
            background: var(--primary);
            color: black;
            border: none;
            padding: 0 15px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
        }

        /* --- SHARE MODAL --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0; top: 0; 
            width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.8); 
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--bg-card);
            margin: 15% auto; 
            padding: 2rem; 
            border: 1px solid var(--border); 
            width: 90%; max-width: 400px; 
            border-radius: 12px;
            position: relative;
        }
        .close-modal {
            position: absolute; top: 10px; right: 15px;
            color: var(--text-muted); font-size: 1.5rem; cursor: pointer;
        }
        .friend-list-select {
            max-height: 200px; overflow-y: auto; margin: 1rem 0;
            border: 1px solid var(--border); padding: 0.5rem; border-radius: 4px;
        }
        .friend-option {
            display: flex; align-items: center; gap: 10px; padding: 8px;
            border-bottom: 1px solid #333;
        }
        .friend-option:last-child { border-bottom: none; }
        .btn-send-share {
            width: 100%; background: var(--primary); color: black; border: none;
            padding: 10px; border-radius: 20px; font-weight: bold; cursor: pointer;
        }
        
        /* Responsive */
        @media (max-width: 1000px) {
            .app-container { grid-template-columns: 80px 1fr 0px; } /* Hide Right sidebar on tablet */
            .sidebar-right { display: none; }
            .nav-text { display: none; } /* Show icons only */
            .logo { font-size: 1rem; }
        }
    </style>
</head>
<body>

<div class="app-container">
    
    <aside class="sidebar-left">
        <div class="logo">Mossaq<span>.</span></div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a th:href="@{/main}" class="nav-link" th:classappend="${activeTab == 'home' or activeTab == null} ? 'active'">
                    <span class="nav-icon">üè†</span> <span class="nav-text">Home</span>
                </a>
            </li>
            <li class="nav-item">
                <a th:href="@{/library}" class="nav-link" th:classappend="${activeTab == 'library'} ? 'active'">
                    <span class="nav-icon">üéµ</span> <span class="nav-text">My Playlist</span>
                </a>
            </li>
            <li class="nav-item">
                <a th:href="@{/shared}" class="nav-link" th:classappend="${activeTab == 'shared'} ? 'active'">
                    <span class="nav-icon">üì®</span> <span class="nav-text">Shared with Me</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/profile" class="nav-link">
                    <span class="nav-icon">üë§</span> <span class="nav-text">Profile</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/settings" class="nav-link">
                    <span class="nav-icon">‚öôÔ∏è</span> <span class="nav-text">Settings</span>
                </a>
            </li>
        </ul>
    </aside>

    <!-- Flash Messages -->
    <div th:if="${message}" style="position: fixed; top: 20px; right: 20px; background: #1db954; color: black; padding: 10px 20px; border-radius: 4px; z-index: 3000;" th:text="${message}"></div>
    <div th:if="${error}" style="position: fixed; top: 20px; right: 20px; background: #ff4b4b; color: white; padding: 10px 20px; border-radius: 4px; z-index: 3000;" th:text="${error}"></div>

    <main class="main-feed">
        <header class="feed-header">
            <h2 th:text="${sectionTitle} ?: 'Discover'">Discover</h2>
        </header>

        <article class="track-card" th:each="track : ${tracks}" th:data-track-id="${track.id}" onclick="openTrackPage(event, this.getAttribute('data-track-id'))">
            <div class="track-header">
                <img th:src="@{'/track/' + ${track.id} + '/art'}" class="artist-avatar" alt="Cover" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCI+PHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjMzMzIi8+PC9zdmc+'">
                <div class="track-info">
                    <h3><a th:href="@{/track(uuid=${track.id})}" th:text="${track.title}">Track Title</a></h3>
                    <span>By <strong th:text="${track.artist}">Artist</strong></span>
                </div>
            </div>

            <div class="audio-player-ui">
                <button class="play-btn" th:data-track-id="${track.id}" onclick="togglePlay(this, this.getAttribute('data-track-id'))">‚ñ∂</button>
                <div class="player-body">
                    <div class="waveform">
                        <!-- Generate 200 bars dynamically to fill the width -->
                        <div class="bar" th:each="i : ${#numbers.sequence(0, 200)}" th:style="|animation-duration: 0.${(i % 6) + 4}s; animation-delay: -0.${i % 9}s|"></div>
                    </div>
                    <div class="seek-wrapper">
                        <span class="time-text current">0:00</span>
                        <input type="range" class="seek-slider" value="0" step="0.1" oninput="seekAudio(this)">
                        <span class="time-text total">--:--</span>
                    </div>
                </div>
                <audio th:id="'audio-' + ${track.id}" th:src="@{'/track/' + ${track.id} + '/stream'}" onended="resetPlayerUI(this)" ontimeupdate="updateProgress(this)" onloadedmetadata="initAudio(this)"></audio>
            </div>

            <div class="track-actions">
                <button class="action-btn like" th:data-track-id="${track.id}" onclick="toggleLike(this, this.getAttribute('data-track-id'))">‚ô• <span th:text="${track.likeCount}">90</span></button>
                <button class="action-btn" th:data-track-id="${track.id}" onclick="toggleComments(this.getAttribute('data-track-id'))">üí¨ <span th:text="${track.commentCount}">45</span></button>
                <button class="action-btn" th:data-track-id="${track.id}" onclick="openShareModal(this.getAttribute('data-track-id'))">üîó Share</button>
            </div>

            <div th:id="'comments-' + ${track.id}" class="comment-box">
                <form th:action="@{'/track/' + ${track.id} + '/comment'}" method="post" class="comment-form">
                    <input type="text" name="content" class="comment-input" placeholder="Add a comment..." required>
                    <button type="submit" class="btn-comment">Post</button>
                </form>
            </div>
        </article>

        <div th:if="${#lists.isEmpty(tracks)}" style="text-align: center; padding: 2rem; color: var(--text-muted);">
            <p>No tracks found. Upload one to get started!</p>
        </div>

    </main>

    <aside class="sidebar-right">
        
        <div class="upload-box">
            <h4>Upload Music</h4>
            <p>Share your sound with the world.</p>
            <form action="/track/upload" method="POST" enctype="multipart/form-data">
                <input type="text" name="title" class="upload-input" placeholder="Track Title" required>
                <input type="file" name="file" accept=".mp3,.wav" class="upload-input" style="padding: 5px;" required>
                <input type="file" name="image" accept="image/*" class="upload-input" style="padding: 5px;">
                <button type="submit" class="btn-upload">Upload Track</button>
            </form>
        </div>

        <div class="suggestions">
            <h4>Artists You May Like</h4>
            
            <div class="artist-row">
                <div class="artist-profile">
                    <div class="mini-avatar"></div>
                    <span class="artist-name">Luna Ray</span>
                </div>
                <button class="btn-follow">Follow</button>
            </div>

            <div class="artist-row">
                <div class="artist-profile">
                    <div class="mini-avatar"></div>
                    <span class="artist-name">The Echoes</span>
                </div>
                <button class="btn-follow">Follow</button>
            </div>

            <div class="artist-row">
                <div class="artist-profile">
                    <div class="mini-avatar"></div>
                    <span class="artist-name">Bass Walker</span>
                </div>
                <button class="btn-follow">Follow</button>
            </div>

        </div>
    </aside>

    <!-- Share Modal -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeShareModal()">&times;</span>
            <h3>Share with Friends</h3>
            <form action="/track/share" method="post">
                <input type="hidden" name="trackId" id="shareTrackId">
                <div class="friend-list-select">
                    <div th:each="friend : ${friends}" class="friend-option">
                        <input type="checkbox" name="recipientIds" th:value="${friend.uuid}" th:id="'friend-' + ${friend.uuid}">
                        <label th:for="'friend-' + ${friend.uuid}" th:text="${friend.username}" style="cursor: pointer; flex: 1;">Friend Name</label>
                    </div>
                    <div th:if="${#lists.isEmpty(friends)}" style="color: var(--text-muted); text-align: center; padding: 10px;">No friends found. Add some friends first!</div>
                </div>
                <button type="submit" class="btn-send-share" th:disabled="${#lists.isEmpty(friends)}">Send</button>
            </form>
        </div>
    </div>

</div>

<script>
    let currentAudio = null;
    let currentBtn = null;
    let currentContainer = null;

    window.togglePlay = function(btn, trackId) {
        const audio = document.getElementById('audio-' + trackId);
        const container = btn.closest('.audio-player-ui');

        // If clicking a different track, pause the current one
        if (currentAudio && currentAudio !== audio) {
            currentAudio.pause();
            currentBtn.innerText = '‚ñ∂';
            currentContainer.classList.remove('playing');
        }

        if (audio.paused) {
            audio.play();
            btn.innerText = '‚è∏';
            container.classList.add('playing');
            currentAudio = audio;
            currentBtn = btn;
            currentContainer = container;
        } else {
            audio.pause();
            btn.innerText = '‚ñ∂';
            container.classList.remove('playing');
            currentAudio = null;
            currentBtn = null;
            currentContainer = null;
        }
    };

    window.resetPlayerUI = function(audio) {
        const container = audio.closest('.audio-player-ui');
        const btn = container.querySelector('.play-btn');
        
        btn.innerText = '‚ñ∂';
        container.classList.remove('playing');
        
        if (currentAudio === audio) {
            currentAudio = null;
            currentBtn = null;
            currentContainer = null;
        }
    }

    function initAudio(audio) {
        const container = audio.closest('.audio-player-ui');
        const slider = container.querySelector('.seek-slider');
        const totalTimeEl = container.querySelector('.time-text.total');
        
        if(slider && totalTimeEl && audio.duration) {
             slider.max = audio.duration;
             totalTimeEl.innerText = formatTime(audio.duration);
        }
    }

    function updateProgress(audio) {
        const container = audio.closest('.audio-player-ui');
        const slider = container.querySelector('.seek-slider');
        const currentTimeEl = container.querySelector('.time-text.current');
        
        if(slider) slider.value = audio.currentTime;
        if(currentTimeEl) currentTimeEl.innerText = formatTime(audio.currentTime);
    }

    function seekAudio(slider) {
        const container = slider.closest('.audio-player-ui');
        const audio = container.querySelector('audio');
        audio.currentTime = slider.value;
    }

    function formatTime(seconds) {
        if (!seconds || isNaN(seconds)) return "0:00";
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m}:${s < 10 ? '0' : ''}${s}`;
    }

    function toggleComments(trackId) {
        const section = document.getElementById('comments-' + trackId);
        if (section.style.display === 'block') {
            section.style.display = 'none';
        } else {
            section.style.display = 'block';
        }
    }

    function toggleLike(btn, trackId) {
        fetch('/track/' + trackId + '/like', {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) return response.json();
            throw new Error('Network response was not ok.');
        })
        .then(data => {
            btn.querySelector('span').innerText = data.count;
            if (data.liked) {
                btn.style.color = '#e91e63';
            } else {
                btn.style.color = '';
            }
        })
        .catch(error => console.error('Error liking track:', error));
    }

    function openTrackPage(event, trackId) {
        // Prevent navigation if clicking on interactive elements
        if (event.target.closest('button, a, input, .seek-slider')) return;
        if (window.getSelection().toString().length > 0) return;

        window.location.href = '/track?uuid=' + trackId;
    }

    function openShareModal(trackId) {
        document.getElementById('shareTrackId').value = trackId;
        document.getElementById('shareModal').style.display = 'block';
    }

    function closeShareModal() {
        document.getElementById('shareModal').style.display = 'none';
    }
    
    // Close modal if clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('shareModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>
</body>
</html>